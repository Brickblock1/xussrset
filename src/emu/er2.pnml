 // er2

// Спрайты
// 2 ливреи, до 1972 года и после (принудительная замена),
// плюс 3 ливреи для всех выпущенных с 1972
// С 1974 года выпуск новых в 2-х ливреях, старые бегают по старому
// плюс 3 ливреи 1974 для новых, плюс 2 ливреи с 1990 для новых
// Вариант с электросекциями
// Для моторных: до 1968 старые пантографы, после 1968 - новые

#define IMAGEFILE  "src/emu/er2-1962-1984.png"

/// Головной
// покупка, вариант 1
spriteset (er2_h_purchase_spriteset, IMAGEFILE)
{
  s12_purchase_template(608, 275, -8)
}

// покупка, вариант 3
spriteset (er2_h_v3_purchase_spriteset, IMAGEFILE)
{
  s12_purchase_template(608, 413, -8)
}

// покупка, вариант 8
spriteset (er2_h_v8_purchase_spriteset, IMAGEFILE)
{
  s12_purchase_template(608, 758, -8)
}

// вариант 1, погрузка/перемещение
spriteset (er2_h_loading_spriteset, IMAGEFILE)
{
  s12_template(608, 275, 0)
} 

spriteset (er2_h_traveling_spriteset, IMAGEFILE)
{
  s12_template(1059, 275, 0)
} 

spritegroup er2_h_spritegroup
{
  loading: er2_h_loading_spriteset;
  loaded: er2_h_traveling_spriteset;
}

// вариант 2: погрузка/перемещение
spriteset (er2_h_v2_loading_spriteset, IMAGEFILE)
{
  s12_template(608, 344, 0)
} 

spriteset (er2_h_v2_traveling_spriteset, IMAGEFILE)
{
  s12_template(1059, 344, 0)
} 

spritegroup er2_h_v2_spritegroup
{
  loading: er2_h_v2_loading_spriteset;
  loaded: er2_h_v2_traveling_spriteset;
}

// вариант 3: погрузка/перемещение
spriteset (er2_h_v3_loading_spriteset, IMAGEFILE)
{
  s12_template(608, 413, 0)
} 

spriteset (er2_h_v3_traveling_spriteset, IMAGEFILE)
{
  s12_template(1059, 413, 0)
} 

spritegroup er2_h_v3_spritegroup
{
  loading: er2_h_v3_loading_spriteset;
  loaded: er2_h_v3_traveling_spriteset;
}

// вариант 4: погрузка/перемещение
spriteset (er2_h_v4_loading_spriteset, IMAGEFILE)
{
  s12_template(608, 482, 0)
} 

spriteset (er2_h_v4_traveling_spriteset, IMAGEFILE)
{
  s12_template(1059, 482, 0)
} 

spritegroup er2_h_v4_spritegroup
{
  loading: er2_h_v4_loading_spriteset;
  loaded: er2_h_v4_traveling_spriteset;
}

// вариант 5: погрузка/перемещение
spriteset (er2_h_v5_loading_spriteset, IMAGEFILE)
{
  s12_template(608, 551, 0)
} 

spriteset (er2_h_v5_traveling_spriteset, IMAGEFILE)
{
  s12_template(1059, 551, 0)
} 

spritegroup er2_h_v5_spritegroup
{
  loading: er2_h_v5_loading_spriteset;
  loaded: er2_h_v5_traveling_spriteset;
}

// вариант 6: погрузка/перемещение
spriteset (er2_h_v6_loading_spriteset, IMAGEFILE)
{
  s12_template(608, 620, 0)
} 

spriteset (er2_h_v6_traveling_spriteset, IMAGEFILE)
{
  s12_template(1059, 620, 0)
} 

spritegroup er2_h_v6_spritegroup
{
  loading: er2_h_v6_loading_spriteset;
  loaded: er2_h_v6_traveling_spriteset;
}

// вариант 7: погрузка/перемещение
spriteset (er2_h_v7_loading_spriteset, IMAGEFILE)
{
  s12_template(608, 689, 0)
} 

spriteset (er2_h_v7_traveling_spriteset, IMAGEFILE)
{
  s12_template(1059, 689, 0)
} 

spritegroup er2_h_v7_spritegroup
{
  loading: er2_h_v7_loading_spriteset;
  loaded: er2_h_v7_traveling_spriteset;
}

// вариант 8: погрузка/перемещение
spriteset (er2_h_v8_loading_spriteset, IMAGEFILE)
{
  s12_template(608, 758, 0)
} 

spriteset (er2_h_v8_traveling_spriteset, IMAGEFILE)
{
  s12_template(1059, 758, 0)
} 

spritegroup er2_h_v8_spritegroup
{
  loading: er2_h_v8_loading_spriteset;
  loaded: er2_h_v8_traveling_spriteset;
}

// вариант 9: погрузка/перемещение
spriteset (er2_h_v9_loading_spriteset, IMAGEFILE)
{
  s12_template(608, 827, 0)
} 

spriteset (er2_h_v9_traveling_spriteset, IMAGEFILE)
{
  s12_template(1059, 827, 0)
} 

spritegroup er2_h_v9_spritegroup
{
  loading: er2_h_v9_loading_spriteset;
  loaded: er2_h_v9_traveling_spriteset;
}

// вариант 10: погрузка/перемещение
spriteset (er2_h_v10_loading_spriteset, IMAGEFILE)
{
  s12_template(608, 896, 0)
} 

spriteset (er2_h_v10_traveling_spriteset, IMAGEFILE)
{
  s12_template(1059, 896, 0)
} 

spritegroup er2_h_v10_spritegroup
{
  loading: er2_h_v10_loading_spriteset;
  loaded: er2_h_v10_traveling_spriteset;
}

// вариант 11: погрузка/перемещение
spriteset (er2_h_v11_loading_spriteset, IMAGEFILE)
{
  s12_template(608, 965, 0)
} 

spriteset (er2_h_v11_traveling_spriteset, IMAGEFILE)
{
  s12_template(1059, 965, 0)
} 

spritegroup er2_h_v11_spritegroup
{
  loading: er2_h_v11_loading_spriteset;
  loaded: er2_h_v11_traveling_spriteset;
}

// вариант 12: погрузка/перемещение
spriteset (er2_h_v12_loading_spriteset, IMAGEFILE)
{
  s12_template(608, 1034, 0)
} 

spriteset (er2_h_v12_traveling_spriteset, IMAGEFILE)
{
  s12_template(1059, 1034, 0)
} 

spritegroup er2_h_v12_spritegroup
{
  loading: er2_h_v12_loading_spriteset;
  loaded: er2_h_v12_traveling_spriteset;
}

// вариант 13: погрузка/перемещение
spriteset (er2_h_v13_loading_spriteset, IMAGEFILE)
{
  s12_template(608, 1103, 0)
} 

spriteset (er2_h_v13_traveling_spriteset, IMAGEFILE)
{
  s12_template(1059, 1103, 0)
} 

spritegroup er2_h_v13_spritegroup
{
  loading: er2_h_v13_loading_spriteset;
  loaded: er2_h_v13_traveling_spriteset;
}

// вариант 14: погрузка/перемещение
spriteset (er2_h_v14_loading_spriteset, IMAGEFILE)
{
  s12_template(608, 1172, 0)
} 

spriteset (er2_h_v14_traveling_spriteset, IMAGEFILE)
{
  s12_template(1059, 1172, 0)
} 

spritegroup er2_h_v14_spritegroup
{
  loading: er2_h_v14_loading_spriteset;
  loaded: er2_h_v14_traveling_spriteset;
}

/// Головной развёрнутый

spriteset (er2_hr_spriteset, IMAGEFILE)
{
  s12_template(608, 1244, 0)
} 

spriteset (er2_hr_v2_spriteset, IMAGEFILE)
{
  s12_template(608, 1313, 0)
} 

spriteset (er2_hr_v3_spriteset, IMAGEFILE)
{
  s12_template(608, 1382, 0)
} 

spriteset (er2_hr_v4_spriteset, IMAGEFILE)
{
  s12_template(608, 1451, 0)
} 

spriteset (er2_hr_v5_spriteset, IMAGEFILE)
{
  s12_template(608, 1520, 0)
} 
spriteset (er2_hr_v6_spriteset, IMAGEFILE)
{
  s12_template(608, 1589, 0)
} 
spriteset (er2_hr_v7_spriteset, IMAGEFILE)
{
  s12_template(608, 1658, 0)
} 

spriteset (er2_hr_v8_spriteset, IMAGEFILE)
{
  s12_template(608, 1727, 0)
} 
spriteset (er2_hr_v9_spriteset, IMAGEFILE)
{
  s12_template(608, 1796, 0)
} 

spriteset (er2_hr_v10_spriteset, IMAGEFILE)
{
  s12_template(608, 1865, 0)
} 

spriteset (er2_hr_v11_spriteset, IMAGEFILE)
{
  s12_template(608, 1934, 0)
} 

spriteset (er2_hr_v12_spriteset, IMAGEFILE)
{
  s12_template(608, 2003, 0)
} 

spriteset (er2_hr_v13_spriteset, IMAGEFILE)
{
  s12_template(608, 2072, 0)
} 

spriteset (er2_hr_v14_spriteset, IMAGEFILE)
{
  s12_template(608, 2141, 0)
} 

/// Моторный
// покупка
spriteset (er2_m_purchase_spriteset, IMAGEFILE)
{
  s12_purchase_template(157, 2210, -8)
}

spriteset (er2_m_v3_purchase_spriteset, IMAGEFILE)
{
  s12_purchase_template(157, 2348, -8)
}

spriteset (er2_m_spriteset, IMAGEFILE)
{
  s12_template(608, 2210, 0)
} 

spriteset (er2_m_notpowered_spriteset, IMAGEFILE)
{
  s12_template(157, 2210, 0)
} 

spriteset (er2_m_v2_spriteset, IMAGEFILE)
{
  s12_template(608, 2279, 0)
} 

spriteset (er2_m_v2_notpowered_spriteset, IMAGEFILE)
{
  s12_template(157, 2279, 0)
} 

spriteset (er2_m_v3_spriteset, IMAGEFILE)
{
  s12_template(608, 2348, 0)
} 

spriteset (er2_m_v3_notpowered_spriteset, IMAGEFILE)
{
  s12_template(157, 2348, 0)
} 

spriteset (er2_m_v4_spriteset, IMAGEFILE)
{
  s12_template(608, 2417, 0)
} 

spriteset (er2_m_v4_notpowered_spriteset, IMAGEFILE)
{
  s12_template(157, 2417, 0)
} 

spriteset (er2_m_v5_spriteset, IMAGEFILE)
{
  s12_template(608, 2486, 0)
} 

spriteset (er2_m_v5_notpowered_spriteset, IMAGEFILE)
{
  s12_template(157, 2486, 0)
} 

spriteset (er2_m_v6_spriteset, IMAGEFILE)
{
  s12_template(608, 2555, 0)
} 

spriteset (er2_m_v6_notpowered_spriteset, IMAGEFILE)
{
  s12_template(157, 2555, 0)
} 

spriteset (er2_m_v7_spriteset, IMAGEFILE)
{
  s12_template(608, 2624, 0)
} 

spriteset (er2_m_v7_notpowered_spriteset, IMAGEFILE)
{
  s12_template(157, 2624, 0)
} 

spriteset (er2_m_v8_spriteset, IMAGEFILE)
{
  s12_template(608, 2693, 0)
} 

spriteset (er2_m_v8_notpowered_spriteset, IMAGEFILE)
{
  s12_template(157, 2693, 0)
} 

spriteset (er2_m_v9_spriteset, IMAGEFILE)
{
  s12_template(608, 2762, 0)
} 

spriteset (er2_m_v9_notpowered_spriteset, IMAGEFILE)
{
  s12_template(157, 2762, 0)
} 

/// моторный развёрнутый
spriteset (er2_mr_spriteset, IMAGEFILE)
{
  s12_template(608, 2831, 0)
} 

spriteset (er2_mr_notpowered_spriteset, IMAGEFILE)
{
  s12_template(157, 2831, 0)
} 

spriteset (er2_mr_v2_spriteset, IMAGEFILE)
{
  s12_template(608, 2900, 0)
} 

spriteset (er2_mr_v2_notpowered_spriteset, IMAGEFILE)
{
  s12_template(157, 2900, 0)
} 

spriteset (er2_mr_v3_spriteset, IMAGEFILE)
{
  s12_template(608, 2969, 0)
} 

spriteset (er2_mr_v3_notpowered_spriteset, IMAGEFILE)
{
  s12_template(157, 2969, 0)
} 

spriteset (er2_mr_v4_spriteset, IMAGEFILE)
{
  s12_template(608, 3038, 0)
} 

spriteset (er2_mr_v4_notpowered_spriteset, IMAGEFILE)
{
  s12_template(157, 3038, 0)
} 

spriteset (er2_mr_v5_spriteset, IMAGEFILE)
{
  s12_template(608, 3107, 0)
} 

spriteset (er2_mr_v5_notpowered_spriteset, IMAGEFILE)
{
  s12_template(157, 3107, 0)
} 

spriteset (er2_mr_v6_spriteset, IMAGEFILE)
{
  s12_template(608, 3176, 0)
} 

spriteset (er2_mr_v6_notpowered_spriteset, IMAGEFILE)
{
  s12_template(157, 3176, 0)
} 

spriteset (er2_mr_v7_spriteset, IMAGEFILE)
{
  s12_template(608, 3245, 0)
} 

spriteset (er2_mr_v7_notpowered_spriteset, IMAGEFILE)
{
  s12_template(157, 3245, 0)
} 

spriteset (er2_mr_v8_spriteset, IMAGEFILE)
{
  s12_template(608, 3314, 0)
} 

spriteset (er2_mr_v8_notpowered_spriteset, IMAGEFILE)
{
  s12_template(157, 3314, 0)
} 

spriteset (er2_mr_v9_spriteset, IMAGEFILE)
{
  s12_template(608, 3383, 0)
} 

spriteset (er2_mr_v9_notpowered_spriteset, IMAGEFILE)
{
  s12_template(157, 3383, 0)
} 

/// прицепной

spriteset (er2_c_purchase_spriteset, IMAGEFILE)
{
  s12_purchase_template(608, 3452, -8)
}

spriteset (er2_c_spriteset, IMAGEFILE)
{
  s12_template(608, 3452, 0)
} 

spriteset (er2_c_v2_spriteset, IMAGEFILE)
{
  s12_template(608, 3521, 0)
} 

spriteset (er2_c_v3_spriteset, IMAGEFILE)
{
  s12_template(608, 3590, 0)
} 

spriteset (er2_c_v4_spriteset, IMAGEFILE)
{
  s12_template(608, 3659, 0)
} 

spriteset (er2_c_v5_spriteset, IMAGEFILE)
{
  s12_template(608, 3728, 0)
} 

spriteset (er2_c_v6_spriteset, IMAGEFILE)
{
  s12_template(608, 3797, 0)
} 

spriteset (er2_c_v7_spriteset, IMAGEFILE)
{
  s12_template(608, 3866, 0)
} 

spriteset (er2_cr_spriteset, IMAGEFILE)
{
  s12_template(608, 3935, 0)
} 

spriteset (er2_cr_v2_spriteset, IMAGEFILE)
{
  s12_template(608, 4004, 0)
} 

spriteset (er2_cr_v3_spriteset, IMAGEFILE)
{
  s12_template(608, 4073, 0)
} 

spriteset (er2_cr_v4_spriteset, IMAGEFILE)
{
  s12_template(608, 4142, 0)
} 

spriteset (er2_cr_v5_spriteset, IMAGEFILE)
{
  s12_template(608, 4211, 0)
} 

spriteset (er2_cr_v6_spriteset, IMAGEFILE)
{
  s12_template(608, 4280, 0)
} 

spriteset (er2_cr_v7_spriteset, IMAGEFILE)
{
  s12_template(608, 4349, 0)
} 

#undef IMAGEFILE

// рисуем развёрнутый моторный
switch (FEAT_TRAINS, SELF, er2_get_spriteset8,
  LOAD_TEMP(0) +
  ((build_year >= 1968) * 2) +
  ((vehicle_is_not_powered || vehicle_is_in_depot || (LOAD_TEMP(1) != er2)) * 9)
)
{
  0: er2_mr_spriteset;
  1: er2_mr_v2_spriteset;

  2: er2_mr_v3_spriteset;
  3: er2_mr_v4_spriteset;
  4: er2_mr_v5_spriteset;
  5: er2_mr_v6_spriteset;
  6: er2_mr_v7_spriteset;
  7: er2_mr_v8_spriteset;
  8: er2_mr_v9_spriteset;

  9: er2_mr_notpowered_spriteset;
  10: er2_mr_v2_notpowered_spriteset;
  11: er2_mr_v3_notpowered_spriteset;
  12: er2_mr_v4_notpowered_spriteset;
  13: er2_mr_v5_notpowered_spriteset;
  14: er2_mr_v6_notpowered_spriteset;
  15: er2_mr_v7_notpowered_spriteset;
  16: er2_mr_v8_notpowered_spriteset;
  17: er2_mr_v9_notpowered_spriteset;
  align_12_spriteset;
}

// рисуем моторный
switch (FEAT_TRAINS, SELF, er2_get_spriteset7,
  LOAD_TEMP(0) +
  ((build_year >= 1968) * 2) +
  ((vehicle_is_not_powered || vehicle_is_in_depot || (LOAD_TEMP(1) != er2)) * 9)
)
{
  0: er2_m_spriteset;
  1: er2_m_v2_spriteset;

  2: er2_m_v3_spriteset;
  3: er2_m_v4_spriteset;
  4: er2_m_v5_spriteset;
  5: er2_m_v6_spriteset;
  6: er2_m_v7_spriteset;
  7: er2_m_v8_spriteset;
  8: er2_m_v9_spriteset;

  9: er2_m_notpowered_spriteset;
  10: er2_m_v2_notpowered_spriteset;
  11: er2_m_v3_notpowered_spriteset;
  12: er2_m_v4_notpowered_spriteset;
  13: er2_m_v5_notpowered_spriteset;
  14: er2_m_v6_notpowered_spriteset;
  15: er2_m_v7_notpowered_spriteset;
  16: er2_m_v8_notpowered_spriteset;
  17: er2_m_v9_notpowered_spriteset;
  align_12_spriteset;
}

// рисуем развёрнутый прицепной
switch (FEAT_TRAINS, SELF, er2_get_spriteset6,
  LOAD_TEMP(0)
)
{
  0: er2_cr_spriteset;
  1: er2_cr_v2_spriteset;
  2: er2_cr_v3_spriteset;
  3: er2_cr_v4_spriteset;
  4: er2_cr_v5_spriteset;
  5: er2_cr_v6_spriteset;
  6: er2_cr_v7_spriteset;
  align_12_spriteset;
}

// рисуем прицепной
switch (FEAT_TRAINS, SELF, er2_get_spriteset5,
  LOAD_TEMP(0)
)
{
  0: er2_c_spriteset;
  1: er2_c_v2_spriteset;
  2: er2_c_v3_spriteset;
  3: er2_c_v4_spriteset;
  4: er2_c_v5_spriteset;
  5: er2_c_v6_spriteset;
  6: er2_c_v7_spriteset;
  align_12_spriteset;
}

// рисуем развёрнутую голову
switch (FEAT_TRAINS, SELF, er2_get_spriteset4,
  LOAD_TEMP(0) +
  ((current_year >= 1972) * (build_year < 1974) * 2) +
  ((build_year >= 1974) * 7)
)
{
  0: er2_hr_spriteset;
  1: er2_hr_v2_spriteset;

  2: er2_hr_v3_spriteset;
  3: er2_hr_v4_spriteset;
  4: er2_hr_v5_spriteset;
  5: er2_hr_v6_spriteset;
  6: er2_hr_v7_spriteset;

  7: er2_hr_v8_spriteset;
  8: er2_hr_v9_spriteset;
  9: er2_hr_v10_spriteset;
  10: er2_hr_v11_spriteset;
  11: er2_hr_v12_spriteset;
  12: er2_hr_v13_spriteset;
  13: er2_hr_v14_spriteset;
  align_12_spriteset;
}

// рисуем обычную голову
switch (FEAT_TRAINS, SELF, er2_get_spriteset3,
  LOAD_TEMP(0) +
  ((current_year >= 1972) * (build_year < 1974) * 2) +
  ((build_year >= 1974) * 7)
)
{
  0: er2_h_spritegroup;
  1: er2_h_v2_spritegroup;

  2: er2_h_v3_spritegroup;
  3: er2_h_v4_spritegroup;
  4: er2_h_v5_spritegroup;
  5: er2_h_v6_spritegroup;
  6: er2_h_v7_spritegroup;

  7: er2_h_v8_spritegroup;
  8: er2_h_v9_spritegroup;
  9: er2_h_v10_spritegroup;
  10: er2_h_v11_spritegroup;
  11: er2_h_v12_spritegroup;
  12: er2_h_v13_spritegroup;
  13: er2_h_v14_spritegroup;
  align_12_spriteset;
}

// голова, прицепной, развёрнутый моторный
// кол-во er2 от текущего до конца, получаем относительное положение er2
// TEMP0 - cargo_subtype, TEMP1 - vehicle_type_id
switch (FEAT_TRAINS, SELF, er2_get_spriteset2,
[
  STORE_TEMP(cargo_subtype, 0),
  STORE_TEMP(count_veh_id(er2), 3),
  STORE_TEMP(LOAD_TEMP(2) - 2, 4),
  STORE_TEMP((LOAD_TEMP(4)/2) + (LOAD_TEMP(4)%2), 4),
  ((LOAD_TEMP(2) - LOAD_TEMP(3)) == 0) ? 0 : // голова
  (LOAD_TEMP(3) == 1) ? 1 :                  // хвост
  ((LOAD_TEMP(2) - LOAD_TEMP(3)) <= LOAD_TEMP(4)) ? 2 : 1 // между
])
{
  0: er2_get_spriteset3; // голова
  1: er2_get_spriteset8; // развёрнутый моторный
  2: er2_get_spriteset5; // прицепной
  align_12_spriteset;
}

// всего er2 в составе
switch (FEAT_TRAINS, PARENT, er2_get_spriteset1,
[
  STORE_TEMP(count_veh_id(er2), 2),
  STORE_TEMP(vehicle_type_id, 1)
])
{
  er2_get_spriteset2;
}

// рисуем на карте?
switch (FEAT_TRAINS, SELF, er2_get_spriteset,
  is_drawn_in_viewport() && is_hidden_at(1))
{
  1: dummy_spriteset;
  er2_get_spriteset1;
}

// голова, прицепной, развёрнутый моторный
// кол-во er2 от текущего до конца, получаем относительное положение er2
// TEMP0 - cargo_subtype, TEMP1 - vehicle_type_id
switch (FEAT_TRAINS, SELF, er2_t_get_spriteset2,
[
  STORE_TEMP(-2, 0x10F),
  STORE_TEMP(var[0x61, 0, 0xFF, 0xF2], 0),
  STORE_TEMP(count_veh_id(er2), 3),
  STORE_TEMP(LOAD_TEMP(2) - 2, 4),
  STORE_TEMP((LOAD_TEMP(4)/2) + (LOAD_TEMP(4)%2) + 1, 4),
  ((LOAD_TEMP(2) - LOAD_TEMP(3)) == 1) ? 0 : // голова
  (LOAD_TEMP(3) == 0) ? 1 :                  // хвост
  ((LOAD_TEMP(2) - LOAD_TEMP(3)) <= LOAD_TEMP(4)) ? 0 : 2 // между
])
{
  0: er2_get_spriteset7; // моторный
  1: er2_get_spriteset4; // развёрнутый головной
  2: er2_get_spriteset6; // развёрнутый прицепной
  align_12_spriteset;
}

// всего er2 в составе
switch (FEAT_TRAINS, PARENT, er2_t_get_spriteset1,
[
  STORE_TEMP(count_veh_id(er2), 2),
  STORE_TEMP(vehicle_type_id, 1)
])
{
  er2_t_get_spriteset2;
}

// рисуем на карте?
switch (FEAT_TRAINS, SELF, er2_t_get_spriteset,
  is_drawn_in_viewport() && is_hidden_at(1))
{
  1: dummy_spriteset;
  er2_t_get_spriteset1;
}

// покупка
switch (FEAT_TRAINS, SELF, er2_get_purchase_spriteset,
  (current_year >= 1972)+
  (current_year >= 1974)
)
{
  0: er2_h_purchase_spriteset;
  1: er2_h_v3_purchase_spriteset;
  er2_h_v8_purchase_spriteset;
}

// Более 12 вагонов в составе нельзя
switch (FEAT_TRAINS, PARENT, er2_can_attach_wagon1,
  count_veh_id(er2) > 5)
{
  1: return string(STR_CAN_ATTACH_NO_MORE_THAN_12_UNITS);
  return CB_RESULT_ATTACH_ALLOW;
}

// Можно присоединять только компоненты ЭР1
switch (FEAT_TRAINS, SELF, er2_can_attach_wagon,
  vehicle_type_id)
{
  er2: er2_can_attach_wagon1;
  return CB_RESULT_ATTACH_DISALLOW;
}

switch (FEAT_TRAINS, PARENT, er2_start_stop,
  count_veh_id(er2))
{
  2..6: return CB_RESULT_NO_TEXT;
  return string(STR_START_STOP_WRONG_TRAIN_LENGTH_SHOULD_BE_4_6_8_10_12);
}

switch (FEAT_TRAINS, SELF, er2_cargo_subtype_text3,
  build_year >= 1990)
{
  1: string(STR_REFIT_UKRAINIAN_RAILWAY);
  return CB_RESULT_NO_TEXT;
}

switch (FEAT_TRAINS, SELF, er2_cargo_subtype_text2,
  build_year >= 1972)
{
  1: string(STR_REFIT_MOSCOW_RAILWAY);
  return CB_RESULT_NO_TEXT;
}

switch (FEAT_TRAINS, SELF, er2_cargo_subtype_text,
  cargo_subtype)
{
  0: string(STR_REFIT_GREEN_GRASS);
  1: string(STR_REFIT_RAL_6020);
  2: er2_cargo_subtype_text2;
  3: string(STR_REFIT_OCTOBER_RAILWAY);
  4: string(STR_REFIT_WEST_SIBERIAN_RAILWAY);
  5: er2_cargo_subtype_text3;
  6: string(STR_REFIT_LDZ);
  return CB_RESULT_NO_TEXT;
}

switch (FEAT_TRAINS, SELF, er2_articulated_part,
  extra_callback_info1)
{
  1: return dummy4;
  2: return tender;
  3: return dummy4;
  return CB_RESULT_NO_MORE_ARTICULATED_PARTS;
}

// даём тягу, если локомотив er2
switch (FEAT_TRAINS, PARENT, er2_power,
  vehicle_type_id == er2)
{
  1: return 959-13; // Поправка, чтобы показывалось 959
  return 0;
}

switch (FEAT_TRAINS, SELF, er2_weight1,
[
  STORE_TEMP(count_veh_id(er2), 2),
  (((LOAD_TEMP(1) - LOAD_TEMP(2)) == 0) || (LOAD_TEMP(2) == 1)) ? 0 : 1
])
{
  0: return int(40.9 + 54.6);
  return int(38.3 + 54.6);
}

switch (FEAT_TRAINS, PARENT, er2_weight,
  STORE_TEMP(count_veh_id(er2), 1))
{
  er2_weight1;
}

switch (FEAT_TRAINS, SELF, er2_cargo_capacity1,
[
  STORE_TEMP(count_veh_id(er2), 2),
  (((LOAD_TEMP(1) - LOAD_TEMP(2)) == 0) || (LOAD_TEMP(2) == 1)) ? 0 : 1
])
{
  0: return int(84 + 110);
  return int(108 + 110);
}

switch (FEAT_TRAINS, PARENT, er2_cargo_capacity,
  STORE_TEMP(count_veh_id(er2), 1))
{
  er2_cargo_capacity1;
}

switch (FEAT_TRAINS, SELF, er2_visual_effect_and_powered1,
[
  STORE_TEMP(count_veh_id(er2), 2),
  STORE_TEMP(LOAD_TEMP(1) - 2, 3),
  STORE_TEMP((LOAD_TEMP(3)/2) + (LOAD_TEMP(3)%2), 3),
  ((LOAD_TEMP(1) - LOAD_TEMP(2)) == 0) ? 0 : // голова
  (LOAD_TEMP(2) == 1) ? 1 :                  // хвост
  ((LOAD_TEMP(1) - LOAD_TEMP(2)) <= LOAD_TEMP(3)) ? 2 : 1 // между
])
{
  1: return visual_effect_and_powered(VISUAL_EFFECT_ELECTRIC, 0, 
    DISABLE_WAGON_POWER);
  return visual_effect_and_powered(VISUAL_EFFECT_DISABLE, 0,
    DISABLE_WAGON_POWER);
}

switch (FEAT_TRAINS, PARENT, er2_visual_effect_and_powered,
  STORE_TEMP(count_veh_id(er2), 1))
{
  er2_visual_effect_and_powered1;
}

switch (FEAT_TRAINS, SELF, er2_t_visual_effect_and_powered1,
[
  STORE_TEMP(count_veh_id(er2), 2),
  STORE_TEMP(LOAD_TEMP(1) - 2, 3),
  STORE_TEMP((LOAD_TEMP(3)/2) + (LOAD_TEMP(3)%2) + 1, 3),
  ((LOAD_TEMP(1) - LOAD_TEMP(2)) == 1) ? 0 : // голова
  (LOAD_TEMP(2) == 0) ? 1 :                  // хвост
  ((LOAD_TEMP(1) - LOAD_TEMP(2)) <= LOAD_TEMP(3)) ? 0 : 2 // между
])
{
  0: return visual_effect_and_powered(VISUAL_EFFECT_ELECTRIC, 0, 
    DISABLE_WAGON_POWER);
  return visual_effect_and_powered(VISUAL_EFFECT_DISABLE, 0,
    DISABLE_WAGON_POWER);
}

switch (FEAT_TRAINS, PARENT, er2_t_visual_effect_and_powered,
  STORE_TEMP(count_veh_id(er2), 1))
{
  er2_t_visual_effect_and_powered1;
}


item (FEAT_TRAINS, er2) 
{
  property
  {
    name: string(STR_ER2_NAME);
    climates_available: get_climates_available();
    introduction_date: date(1962, 1, 1);
    model_life: 30; // VEHICLE_NEVER_EXPIRES;
    vehicle_life: 30; // срок службы
    reliability_decay: 20;
    refittable_cargo_classes: bitmask(CC_PASSENGERS);
    loading_speed: 28; // скорость погрузки/выгрузки, пассажиров
    cost_factor: get_emu_cost_factor();
    running_cost_factor: get_emu_running_cost_factor();
    sprite_id: SPRITE_ID_NEW_TRAIN;
    speed: 130 km/h;
    misc_flags: bitmask(TRAIN_FLAG_MU);
    refit_cost: 0;
    track_type: ELRL;
    ai_special_flag: AI_FLAG_PASSENGER;
    power: 959 hpM;
    running_cost_base: RUNNING_COST_ELECTRIC;
    cargo_capacity: (84 + 110);
    weight: (40.9 + 54.6) ton;
    ai_engine_rank: 0;
    engine_class: ENGINE_CLASS_ELECTRIC;
    extra_power_per_wagon: 0 kW;
    tractive_effort_coefficient: 0.0384437951; //0.037593984962;
    shorten_vehicle: SHORTEN_TO_8_8;
    extra_weight_per_wagon: 0;
    bitmask_vehicle_info: 0;
  }
  graphics {
    default: er2_get_spriteset;
    purchase: er2_get_purchase_spriteset;
    articulated_part: er2_articulated_part;
    can_attach_wagon: er2_can_attach_wagon;
    start_stop: er2_start_stop;
    speed: speed_after30_130to100;
    additional_text: return string(STR_ER2_PURCHASE_HINT);
    cargo_subtype_text: er2_cargo_subtype_text;
    weight: er2_weight;
    cargo_capacity: er2_cargo_capacity;
    power: er2_power;
    visual_effect_and_powered: er2_visual_effect_and_powered;
  }
  livery_override(tender)
  {
    shorten_vehicle: return SHORTEN_TO_8_8;
    visual_effect_and_powered: er2_t_visual_effect_and_powered;
    er2_t_get_spriteset;
  }
}
