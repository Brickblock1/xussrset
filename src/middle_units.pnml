// Специальная проверка для управления присоединением 3ТЭ10М, 3ТЭ10У, 4ТЭ10С; 3М62У; 3ЭС5К.

switch (FEAT_TRAINS, PARENT, other_can_attach_wagon,
[  
   set_offset_to(num_vehs_in_consist-2),
   ( (prev_vehicle_type_id() == _3te10m_m) +
     (prev_vehicle_type_id() == _3te10u_m) +     
     (prev_vehicle_type_id() == _4te10s_m) +    
     (prev_vehicle_type_id() == _3m62u_m) + 
     (prev_vehicle_type_id() == _3es5k_m) )
])
{
  1: return string(STR_CAN_ATTACH_NO_AFTER_MIDDLE_UNIT);
     return CB_RESULT_ATTACH_ALLOW;
}

switch (FEAT_TRAINS, PARENT, m_3te10m_can_attach_wagon_m,
[  set_offset_to(num_vehs_in_consist-4),
   STORE_TEMP ( ((prev_vehicle_type_id() == _3te10m_m) || 
                 (prev_vehicle_type_id() == _3te10u_m) || 
                 (prev_vehicle_type_id() == _4te10s_m) || 
                 (prev_vehicle_type_id() == _3m62u_m) || 
                 (prev_vehicle_type_id() == _3es5k_m)), 3),
   set_offset_to(num_vehs_in_consist-2),
   ((prev_vehicle_type_id() == _2te10m) ||
    (prev_vehicle_type_id() == _3te10m)) && 
   (!LOAD_TEMP(3))
])
{          
  0: return string(STR_CAN_ATTACH_NO_MIDDLE_UNIT);  
     return CB_RESULT_ATTACH_ALLOW;
}

switch (FEAT_TRAINS, PARENT, m_3te10m_can_attach_wagon_h,
[  set_offset_to(num_vehs_in_consist-2),
   ((prev_vehicle_type_id() == _3te10u_m) || 
    (prev_vehicle_type_id() == _4te10s_m) || 
    (prev_vehicle_type_id() == _3m62u_m) ||
    (prev_vehicle_type_id() == _3es5k_m))  
])
{          
  1: return string(STR_CAN_ATTACH_NO_AFTER_MIDDLE_UNIT);  
     return CB_RESULT_ATTACH_ALLOW;
}

switch (FEAT_TRAINS, PARENT, m_3te10u_can_attach_wagon_m,
[  set_offset_to(num_vehs_in_consist-4),
   STORE_TEMP ( ((prev_vehicle_type_id() == _3te10m_m) || 
                 (prev_vehicle_type_id() == _3te10u_m) || 
                 (prev_vehicle_type_id() == _4te10s_m) || 
                 (prev_vehicle_type_id() == _3m62u_m) || 
                 (prev_vehicle_type_id() == _3es5k_m)) , 3),
   set_offset_to(num_vehs_in_consist-2),
   ((prev_vehicle_type_id() == _2te10u) ||
    (prev_vehicle_type_id() == _3te10u)) &&
   (!LOAD_TEMP(3))
])
{          
  0: return string(STR_CAN_ATTACH_NO_MIDDLE_UNIT);  
     return CB_RESULT_ATTACH_ALLOW;
}

switch (FEAT_TRAINS, PARENT, m_3te10u_can_attach_wagon_h,
[  set_offset_to(num_vehs_in_consist-2),
   ((prev_vehicle_type_id() == _3te10m_m) || 
    (prev_vehicle_type_id() == _4te10s_m) || 
    (prev_vehicle_type_id() == _3m62u_m) ||
    (prev_vehicle_type_id() == _3es5k_m))  
])
{          
  1: return string(STR_CAN_ATTACH_NO_AFTER_MIDDLE_UNIT);  
     return CB_RESULT_ATTACH_ALLOW;
}

switch (FEAT_TRAINS, PARENT, m_4te10s_can_attach_wagon_m,
[  set_offset_to(num_vehs_in_consist-4),
   STORE_TEMP ( ((prev_vehicle_type_id() == _3te10m_m) || 
                 (prev_vehicle_type_id() == _3te10u_m) || 
                 (prev_vehicle_type_id() == _3m62u_m) || 
                 (prev_vehicle_type_id() == _3es5k_m)) , 3),
   set_offset_to(num_vehs_in_consist-6),
   STORE_TEMP ( (prev_vehicle_type_id() == _4te10s_m) || LOAD_TEMP(3), 3),
   set_offset_to(num_vehs_in_consist-2),
   ((prev_vehicle_type_id() == _2te10s) ||
    (prev_vehicle_type_id() == _4te10s) ||
    (prev_vehicle_type_id() == _4te10s_m)) &&
   (!LOAD_TEMP(3))
])
{          
  0: return string(STR_CAN_ATTACH_NO_MIDDLE_UNIT);  
     return CB_RESULT_ATTACH_ALLOW;
}

switch (FEAT_TRAINS, PARENT, m_4te10s_can_attach_wagon_h,
[  set_offset_to(num_vehs_in_consist-2),
   ((prev_vehicle_type_id() == _3te10m_m) || 
    (prev_vehicle_type_id() == _3te10u_m) || 
    (prev_vehicle_type_id() == _3m62u_m) || 
    (prev_vehicle_type_id() == _3es5k_m))  
])
{          
  1: return string(STR_CAN_ATTACH_NO_AFTER_MIDDLE_UNIT);  
     return CB_RESULT_ATTACH_ALLOW;
}

switch (FEAT_TRAINS, PARENT, m_3m62u_can_attach_wagon_m,
[  set_offset_to(num_vehs_in_consist-4),
   STORE_TEMP ( ((prev_vehicle_type_id() == _3te10m_m) || 
                 (prev_vehicle_type_id() == _3te10u_m) || 
                 (prev_vehicle_type_id() == _4te10s_m) || 
                 (prev_vehicle_type_id() == _3m62u_m) || 
                 (prev_vehicle_type_id() == _3es5k_m)) , 3),
   set_offset_to(num_vehs_in_consist-2),
   ((prev_vehicle_type_id() == _2m62u) ||
    (prev_vehicle_type_id() == _3m62u)) && 
   (!LOAD_TEMP(3))
])
{          
  0: return string(STR_CAN_ATTACH_NO_MIDDLE_UNIT);  
     return CB_RESULT_ATTACH_ALLOW;
}

switch (FEAT_TRAINS, PARENT, m_3m62u_can_attach_wagon_h,
[  set_offset_to(num_vehs_in_consist-2),
   ((prev_vehicle_type_id() == _3te10m_m) || 
    (prev_vehicle_type_id() == _3te10u_m) || 
    (prev_vehicle_type_id() == _4te10s_m) || 
    (prev_vehicle_type_id() == _3es5k_m))  
])
{          
  1: return string(STR_CAN_ATTACH_NO_AFTER_MIDDLE_UNIT);  
     return CB_RESULT_ATTACH_ALLOW;
}

switch (FEAT_TRAINS, PARENT, m_3es5k_can_attach_wagon_m,
[  set_offset_to(num_vehs_in_consist-4),
   STORE_TEMP ( ((prev_vehicle_type_id() == _3te10m_m) || 
                 (prev_vehicle_type_id() == _3te10u_m) || 
                 (prev_vehicle_type_id() == _4te10s_m) || 
                 (prev_vehicle_type_id() == _3m62u_m) || 
                 (prev_vehicle_type_id() == _3es5k_m)), 3),
   set_offset_to(num_vehs_in_consist-2),
   ((prev_vehicle_type_id() == _2es5k) || 
    (prev_vehicle_type_id() == _3es5k)) &&
   (!LOAD_TEMP(3))
])
{          
  0: return string(STR_CAN_ATTACH_NO_MIDDLE_UNIT);  
     return CB_RESULT_ATTACH_ALLOW;
}

switch (FEAT_TRAINS, PARENT, m_3es5k_can_attach_wagon_h,
[  set_offset_to(num_vehs_in_consist-2),
   ((prev_vehicle_type_id() == _3te10m_m) || 
    (prev_vehicle_type_id() == _3te10u_m) || 
    (prev_vehicle_type_id() == _4te10s_m) || 
    (prev_vehicle_type_id() == _3m62u_m))  
])
{          
  1: return string(STR_CAN_ATTACH_NO_AFTER_MIDDLE_UNIT);  
     return CB_RESULT_ATTACH_ALLOW;
}

switch (FEAT_TRAINS, SELF, any_can_attach_wagon,
   vehicle_type_id)
{
  _2te10m:   m_3te10m_can_attach_wagon_h;
  _3te10m:   m_3te10m_can_attach_wagon_h;
  _3te10m_m: m_3te10m_can_attach_wagon_m;
             
  _2te10u:   m_3te10u_can_attach_wagon_h;
  _3te10u:   m_3te10u_can_attach_wagon_h;
  _3te10u_m: m_3te10u_can_attach_wagon_m;
  
  _2te10s:   m_4te10s_can_attach_wagon_h;
  _4te10s:   m_4te10s_can_attach_wagon_h;
  _4te10s_m: m_4te10s_can_attach_wagon_m;
  
  _2m62u:    m_3m62u_can_attach_wagon_h;
  _3m62u:    m_3m62u_can_attach_wagon_h;
  _3m62u_m:  m_3m62u_can_attach_wagon_m;

  _2es5k:    m_3es5k_can_attach_wagon_h;
  _3es5k:    m_3es5k_can_attach_wagon_h;
  _3es5k_m:  m_3es5k_can_attach_wagon_m;

             other_can_attach_wagon;
}

switch (FEAT_TRAINS, SELF, any_start_stop,
[  
   set_offset_to(num_vehs_in_consist-2),
   ( (prev_vehicle_type_id() == _3te10m_m) +
     (prev_vehicle_type_id() == _3te10u_m) +     
     (prev_vehicle_type_id() == _4te10s_m) +    
     (prev_vehicle_type_id() == _3m62u_m) + 
     (prev_vehicle_type_id() == _3es5k_m) )
])
{
  1: return string(STR_CANNOT_START_MIDDLELAST);
     return CB_RESULT_NO_TEXT;
}
